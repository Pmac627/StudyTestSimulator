@page "/review-attempt/{AttemptId:int}"
@using Microsoft.AspNetCore.Authorization
@using StudyTestSimulator.Web.Services
@using StudyTestSimulator.Web.Models
@inject ITestService TestService
@inject NavigationManager NavigationManager
@attribute [Authorize]

<PageTitle>Review Test Attempt</PageTitle>

<div class="container mt-4">
    @if (attempt == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Review Test Attempt</h1>
            <button class="btn btn-secondary" @onclick="GoBack">
                <i class="bi bi-arrow-left"></i> Back to History
            </button>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">@attempt.TestCategory.Name</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Date:</strong> @attempt.StartTime.ToLocalTime().ToString("g")
                    </div>
                    <div class="col-md-3">
                        <strong>Score:</strong>
                        <span class="badge @GetScoreBadgeClass(attempt.PercentageScore) fs-6">
                            @attempt.PercentageScore.ToString("F1")%
                        </span>
                        @if (attempt.WasAbandoned)
                        {
                            <span class="badge bg-warning text-dark ms-1">Abandoned</span>
                        }
                    </div>
                    <div class="col">
                        <strong>Correct:</strong> @attempt.CorrectAnswers / @attempt.TotalQuestions
                    </div>
                    @if (attempt.SkippedQuestions > 0)
                    {
                        <div class="col">
                            <strong>Skipped:</strong> @attempt.SkippedQuestions
                        </div>
                    }
                    <div class="col">
                        <strong>Duration:</strong> @GetDuration()
                    </div>
                </div>
            </div>
        </div>

        @foreach (var taq in attempt.TestAttemptQuestions.OrderBy(q => q.QuestionOrder))
        {
            <div class="card mb-3">
                <div class="card-header @GetQuestionHeaderClass(taq) text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            Question @(taq.QuestionOrder + 1)
                            @if (taq.IsSkipped)
                            {
                                <i class="bi bi-dash-circle-fill ms-2"></i>
                            }
                            else if (taq.IsCorrect)
                            {
                                <i class="bi bi-check-circle-fill ms-2"></i>
                            }
                            else
                            {
                                <i class="bi bi-x-circle-fill ms-2"></i>
                            }
                        </h5>
                        <span class="badge bg-light text-dark">
                            @if (taq.IsSkipped)
                            {
                                <text>Skipped</text>
                            }
                            else
                            {
                                <text>Time: @taq.TimeSpentSeconds s</text>
                            }
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    @if (taq.IsSkipped)
                    {
                        <div class="alert alert-secondary mb-3">
                            <i class="bi bi-dash-circle me-1"></i> This question was skipped â€” no answer was selected.
                        </div>
                    }
                    <h5>@taq.Question.QuestionText</h5>
                    
                    @{ var reviewImgSrc = !string.IsNullOrEmpty(taq.Question.ImageUrl) ? taq.Question.ImageUrl : taq.Question.ImageBase64; }
                    @if (!string.IsNullOrEmpty(reviewImgSrc))
                    {
                        <div class="mb-3">
                            <img src="@reviewImgSrc" class="img-fluid" style="max-width: 500px;" alt="Question image" />
                        </div>
                    }

                    <div class="list-group mb-3">
                        @{ var reviewAnswers = taq.Question.Answers.OrderBy(a => a.DisplayOrder).ToList(); }
                        @for (int ai = 0; ai < reviewAnswers.Count; ai++)
                        {
                            var answer = reviewAnswers[ai];
                            var isSelected = taq.SelectedAnswerId == answer.Id;
                            var isCorrect = answer.IsCorrect;
                            var cssClass = isCorrect ? "list-group-item-success" : (isSelected ? "list-group-item-danger" : "");

                            <div class="list-group-item @cssClass">
                                @if (isSelected && !isCorrect)
                                {
                                    <i class="bi bi-x-circle-fill text-danger me-1"></i>
                                }
                                @if (isCorrect)
                                {
                                    <i class="bi bi-check-circle-fill text-success me-1"></i>
                                }
                                @if (isSelected && !isCorrect)
                                {
                                    <strong class="text-danger">Your answer: </strong>
                                }
                                @if (isCorrect)
                                {
                                    <strong class="text-success">Correct answer: </strong>
                                }
                                <span>@((char)('A' + ai)). @answer.AnswerText</span>
                                
                                @if (!string.IsNullOrEmpty(answer.Explanation) && (isSelected || isCorrect))
                                {
                                    <p class="mb-0 mt-2 small"><em>@answer.Explanation</em></p>
                                }
                            </div>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(taq.Question.Explanation))
                    {
                        <div class="alert alert-info">
                            <strong>Explanation:</strong> @taq.Question.Explanation
                        </div>
                    }
                </div>
            </div>
        }

        <div class="text-center mt-4 mb-4">
            <button class="btn btn-primary" @onclick="GoBack">
                <i class="bi bi-arrow-left"></i> Back to History
            </button>
        </div>
    }
</div>

@code {
    [Parameter]
    public int AttemptId { get; set; }

    private TestAttempt? attempt;

    protected override async Task OnInitializedAsync()
    {
        attempt = await TestService.GetTestAttemptDetailsAsync(AttemptId);
    }

    private string GetQuestionHeaderClass(TestAttemptQuestion taq)
    {
        if (taq.IsSkipped) return "bg-secondary";
        if (taq.IsCorrect) return "bg-success";
        return "bg-danger";
    }

    private string GetScoreBadgeClass(decimal score)
    {
        if (score >= 90) return "bg-success";
        if (score >= 70) return "bg-primary";
        if (score >= 50) return "bg-warning";
        return "bg-danger";
    }

    private string GetDuration()
    {
        if (attempt?.EndTime == null) return "In Progress";
        
        var duration = attempt.EndTime.Value - attempt.StartTime;
        if (duration.TotalMinutes < 1)
            return $"{duration.Seconds}s";
        else if (duration.TotalHours < 1)
            return $"{(int)duration.TotalMinutes}m {duration.Seconds}s";
        else
            return $"{(int)duration.TotalHours}h {duration.Minutes}m";
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/test-history");
    }
}
