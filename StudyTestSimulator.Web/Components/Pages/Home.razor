@page "/"
@using Microsoft.AspNetCore.Authorization
@using StudyTestSimulator.Web.Services
@inject ITestService TestService
@attribute [Authorize]

<PageTitle>Home - Study Test Simulator</PageTitle>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">Welcome to Study Test Simulator</h1>
            <p class="lead">Practice tests to help you study and improve your knowledge.</p>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-clipboard-check display-4 text-primary"></i>
                    <h5 class="card-title mt-3">Take a Test</h5>
                    <p class="card-text">Start practicing with available test categories.</p>
                    <a href="/take-test" class="btn btn-primary">Start Testing</a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-pencil-square display-4 text-success"></i>
                    <h5 class="card-title mt-3">Manage Questions</h5>
                    <p class="card-text">Add, edit, or import questions for practice tests.</p>
                    <a href="/manage-questions" class="btn btn-success">Manage Questions</a>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="bi bi-clock-history display-4 text-info"></i>
                    <h5 class="card-title mt-3">View History</h5>
                    <p class="card-text">Review your past test attempts and scores.</p>
                    <a href="/test-history" class="btn btn-info">View History</a>
                </div>
            </div>
        </div>
    </div>

    @if (recentAttempts != null && recentAttempts.Any())
    {
        <div class="row mt-5">
            <div class="col-12">
                <h3>Recent Test Attempts</h3>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Category</th>
                            <th>Score</th>
                            <th>Questions</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var attempt in recentAttempts)
                        {
                            <tr>
                                <td>@attempt.StartTime.ToLocalTime().ToString("g")</td>
                                <td>@attempt.UserEmail</td>
                                <td>@attempt.TestCategory.Name</td>
                                <td>
                                    <span class="badge @GetScoreBadgeClass(attempt.PercentageScore)">
                                        @attempt.PercentageScore.ToString("F1")%
                                    </span>
                                </td>
                                <td>@attempt.CorrectAnswers / @attempt.TotalQuestions</td>
                                <td>@GetTestDuration(attempt)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
</div>

@code {
    private List<Models.TestAttempt>? recentAttempts;

    protected override async Task OnInitializedAsync()
    {
        recentAttempts = await TestService.GetRecentAttemptsAsync(10);
    }

    private string GetScoreBadgeClass(decimal score)
    {
        if (score >= 90) return "bg-success";
        if (score >= 70) return "bg-primary";
        if (score >= 50) return "bg-warning";
        return "bg-danger";
    }

    private string GetTestDuration(Models.TestAttempt attempt)
    {
        if (!attempt.EndTime.HasValue) return "In Progress";
        
        var duration = attempt.EndTime.Value - attempt.StartTime;
        if (duration.TotalMinutes < 1)
            return $"{duration.Seconds}s";
        else if (duration.TotalHours < 1)
            return $"{(int)duration.TotalMinutes}m {duration.Seconds}s";
        else
            return $"{(int)duration.TotalHours}h {duration.Minutes}m";
    }
}
