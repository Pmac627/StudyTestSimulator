@page "/test-history"
@using Microsoft.AspNetCore.Authorization
@using StudyTestSimulator.Web.Services
@using StudyTestSimulator.Web.Models
@inject ITestService TestService
@inject ICategoryService CategoryService
@inject NavigationManager NavigationManager
@attribute [Authorize]

<PageTitle>Test History</PageTitle>

<div class="container mt-4">
    <h1 class="mb-4">Test History</h1>

    <div class="row mb-4">
        <div class="col-md-6">
            <label class="form-label">Filter by Category</label>
            <select class="form-select" @bind="filterCategoryId" @bind:after="ResetAndLoadHistory">
                <option value="0">All Categories</option>
                @if (categories != null)
                {
                    @foreach (var category in categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                }
            </select>
        </div>
    </div>

    @if (testHistory == null)
    {
        <p><em>Loading...</em></p>
    }
    else if (!testHistory.Any())
    {
        <div class="alert alert-info">
            No test history found. Take a test to see results here!
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th class="d-none d-md-table-cell">User</th>
                        <th>Category</th>
                        <th>Score</th>
                        <th class="d-none d-md-table-cell">Questions</th>
                        <th class="d-none d-md-table-cell">Correct</th>
                        <th class="d-none d-md-table-cell">Skipped</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var attempt in testHistory)
                    {
                        <tr>
                            <td>@attempt.StartTime.ToLocalTime().ToString("g")</td>
                            <td class="d-none d-md-table-cell">@attempt.UserEmail</td>
                            <td>@attempt.TestCategory.Name</td>
                            <td>
                                <span class="badge @GetScoreBadgeClass(attempt.PercentageScore) fs-6">
                                    @attempt.PercentageScore.ToString("F1")%
                                </span>
                                @if (attempt.WasAbandoned)
                                {
                                    <span class="badge bg-warning text-dark ms-1 mt-1">Abandoned</span>
                                }
                            </td>
                            <td class="d-none d-md-table-cell">@attempt.TotalQuestions</td>
                            <td class="d-none d-md-table-cell">@attempt.CorrectAnswers</td>
                            <td class="d-none d-md-table-cell">@attempt.SkippedQuestions</td>
                            <td>@GetDuration(attempt)</td>
                            <td>
                                <button class="btn btn-sm btn-primary" @onclick="() => ReviewAttempt(attempt.Id)">
                                    <i class="bi bi-eye"></i> Review
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @* Pagination *@
        @if (totalPages > 1)
        {
            <nav aria-label="Test history pagination">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage - 1)" disabled="@(currentPage == 1)">
                            Previous
                        </button>
                    </li>
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        var pageNum = i;
                        <li class="page-item @(currentPage == pageNum ? "active" : "")">
                            <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                        </li>
                    }
                    <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="() => GoToPage(currentPage + 1)" disabled="@(currentPage == totalPages)">
                            Next
                        </button>
                    </li>
                </ul>
            </nav>
            <p class="text-center text-muted small">
                Showing @((currentPage - 1) * pageSize + 1) - @Math.Min(currentPage * pageSize, totalCount) of @totalCount results
            </p>
        }

        <div class="card mt-4">
            <div class="card-header">
                <h5>Statistics (Current Page)</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4 col-md">
                        <div class="display-6 text-primary">@totalCount</div>
                        <p class="text-muted">Total Tests</p>
                    </div>
                    <div class="col-4 col-md">
                        <div class="display-6 text-success">@testHistory.Average(t => t.PercentageScore).ToString("F1")%</div>
                        <p class="text-muted">Avg Score (Page)</p>
                    </div>
                    <div class="col-4 col-md">
                        <div class="display-6 text-info">@testHistory.Sum(t => t.TotalQuestions)</div>
                        <p class="text-muted">Questions (Page)</p>
                    </div>
                    <div class="col-4 col-md">
                        <div class="display-6 text-warning">@testHistory.Sum(t => t.CorrectAnswers)</div>
                        <p class="text-muted">Correct (Page)</p>
                    </div>
                    <div class="col-4 col-md">
                        <div class="display-6 text-secondary">@testHistory.Sum(t => t.SkippedQuestions)</div>
                        <p class="text-muted">Skipped (Page)</p>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<TestCategory>? categories;
    private List<TestAttempt>? testHistory;
    private int filterCategoryId = 0;
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling((double)totalCount / pageSize);

    protected override async Task OnInitializedAsync()
    {
        categories = await CategoryService.GetAllCategoriesAsync();
        await LoadHistory();
    }

    private async Task ResetAndLoadHistory()
    {
        currentPage = 1;
        await LoadHistory();
    }

    private async Task LoadHistory()
    {
        var result = await TestService.GetAllTestHistoryPagedAsync(
            filterCategoryId > 0 ? filterCategoryId : null,
            currentPage,
            pageSize
        );
        testHistory = result.Items;
        totalCount = result.TotalCount;
    }

    private async Task GoToPage(int page)
    {
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        await LoadHistory();
    }

    private string GetScoreBadgeClass(decimal score)
    {
        if (score >= 90) return "bg-success";
        if (score >= 70) return "bg-primary";
        if (score >= 50) return "bg-warning";
        return "bg-danger";
    }

    private string GetDuration(TestAttempt attempt)
    {
        if (!attempt.EndTime.HasValue) return "In Progress";

        var duration = attempt.EndTime.Value - attempt.StartTime;
        if (duration.TotalMinutes < 1)
            return $"{duration.Seconds}s";
        else if (duration.TotalHours < 1)
            return $"{(int)duration.TotalMinutes}m {duration.Seconds}s";
        else
            return $"{(int)duration.TotalHours}h {duration.Minutes}m";
    }

    private void ReviewAttempt(int attemptId)
    {
        NavigationManager.NavigateTo($"/review-attempt/{attemptId}");
    }
}
